import{a0 as Ie,a as te,G as Te,M as le,S as ue,l as je,ah as Le,q as Ae,b as xe,r as Ce,s as Ue}from"./three-DQDvY0d0.js";import{o as Re}from"./d3-octree-CVJhmTg0.js";import{l as re}from"./d3-scale-BjhC47v6.js";import{m as se}from"./d3-geo-DcF_vwO6.js";function J(t,e){(e==null||e>t.length)&&(e=t.length);for(var n=0,r=Array(e);n<e;n++)r[n]=t[n];return r}function We(t){if(Array.isArray(t))return t}function ke(t){if(Array.isArray(t))return J(t)}function W(t,e,n){if(typeof t=="function"?t===e:t.has(e))return arguments.length<3?e:n;throw new TypeError("Private element is not present on this object")}function ze(t){if(t===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function De(t,e,n){return e=B(e),Xe(t,fe()?Reflect.construct(e,[],B(t).constructor):e.apply(t,n))}function ce(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function Ge(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){return t.get(W(t,e))}function O(t,e,n){ce(t,e),e.set(t,n)}function I(t,e,n){return t.set(W(t,e),n),n}function Fe(t,e){ce(t,e),e.add(t)}function Be(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,ve(r.key),r)}}function Ve(t,e,n){return e&&Be(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}function x(t,e,n){return(e=ve(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function B(t){return B=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},B(t)}function Ne(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&Q(t,e)}function fe(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(fe=function(){return!!t})()}function He(t){if(typeof Symbol<"u"&&t[Symbol.iterator]!=null||t["@@iterator"]!=null)return Array.from(t)}function $e(t,e){var n=t==null?null:typeof Symbol<"u"&&t[Symbol.iterator]||t["@@iterator"];if(n!=null){var r,l,s,o,u=[],a=!0,m=!1;try{if(s=(n=n.call(t)).next,e!==0)for(;!(a=(r=s.call(n)).done)&&(u.push(r.value),u.length!==e);a=!0);}catch(c){m=!0,l=c}finally{try{if(!a&&n.return!=null&&(o=n.return(),Object(o)!==o))return}finally{if(m)throw l}}return u}}function qe(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function Ke(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function Xe(t,e){if(e&&(typeof e=="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return ze(t)}function Q(t,e){return Q=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,r){return n.__proto__=r,n},Q(t,e)}function F(t,e){return We(t)||$e(t,e)||pe(t,e)||qe()}function he(t){return ke(t)||He(t)||pe(t)||Ke()}function Je(t,e){if(typeof t!="object"||!t)return t;var n=t[Symbol.toPrimitive];if(n!==void 0){var r=n.call(t,e);if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}function ve(t){var e=Je(t,"string");return typeof e=="symbol"?e:e+""}function pe(t,e){if(t){if(typeof t=="string")return J(t,e);var n={}.toString.call(t).slice(8,-1);return n==="Object"&&t.constructor&&(n=t.constructor.name),n==="Map"||n==="Set"?Array.from(t):n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?J(t,e):void 0}}var me=function(e){e instanceof Array?e.forEach(me):(e.map&&e.map.dispose(),e.dispose())},de=function(e){e.geometry&&e.geometry.dispose(),e.material&&me(e.material),e.texture&&e.texture.dispose(),e.children&&e.children.forEach(de)},ne=function(e){if(e&&e.children)for(;e.children.length;){var n=e.children[0];e.remove(n),de(n)}};function ye(t,e,n){var r=(90-t)*Math.PI/180,l=(90-e)*Math.PI/180;return{x:n*Math.sin(r)*Math.cos(l),y:n*Math.cos(r),z:n*Math.sin(r)*Math.sin(l)}}function Qe(t){var e=t.x,n=t.y,r=t.z,l=Math.sqrt(e*e+n*n+r*r),s=Math.acos(n/l),o=Math.atan2(r,e);return{lat:90-s*180/Math.PI,lng:90-o*180/Math.PI-(o<-Math.PI/2?360:0),r:l}}function L(t){return t*Math.PI/180}var Me=function(e){return 1-(se(0,(.5-e)*Math.PI)[1]/Math.PI+1)/2},K=function(e){return Math.max(0,Math.min(1,Me(e)))},ae=function(e){return .5-se.invert(0,(2*(1-e)-1)*Math.PI)[1]/Math.PI},Ze=function(e){for(var n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,l=re().domain([1,0]).range([n,r]).clamp(!0),s=re().domain([K(n),K(r)]).range([1,0]).clamp(!0),o=function(b){return s(K(l(b)))},u=e.array,a=0,m=u.length;a<m;a+=2)u[a+1]=o(u[a+1]);e.needsUpdate=!0},ie=function(e,n,r,l){var s=Math.pow(2,e),o=Math.max(0,Math.min(s-1,Math.floor((r+180)*s/360))),u=(90-l)/180;n&&(u=Math.max(0,Math.min(1,Me(u))));var a=Math.floor(u*s);return[o,a]},Z=function(e,n){for(var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,l=arguments.length>3&&arguments[3]!==void 0?arguments[3]:0,s=arguments.length>4?arguments[4]:void 0,o=arguments.length>5?arguments[5]:void 0,u=[],a=Math.pow(2,e),m=360/a,c=180/a,b=s===void 0?a-1:s,y=o===void 0?a-1:o,f=r,E=Math.min(a-1,b);f<=E;f++)for(var p=l,j=Math.min(a-1,y);p<=j;p++){var g=p,w=c;if(n){g=p===0?p:ae(p/a)*a;var v=p+1===a?p+1:ae((p+1)/a)*a;w=(v-g)*180/a}var S=-180+(f+.5)*m,M=90-(g*180/a+w/2),_=w;u.push({x:f,y:p,lng:S,lat:M,latLen:_})}return u},Ye=6,et=7,tt=3,rt=90,P=new WeakMap,T=new WeakMap,X=new WeakMap,D=new WeakMap,d=new WeakMap,V=new WeakMap,C=new WeakMap,A=new WeakMap,G=new WeakSet,ut=(function(t){function e(n){var r,l=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},s=l.tileUrl,o=l.minLevel,u=o===void 0?0:o,a=l.maxLevel,m=a===void 0?17:a,c=l.mercatorProjection,b=c===void 0?!0:c;return Ge(this,e),r=De(this,e),Fe(r,G),O(r,P,void 0),O(r,T,void 0),O(r,X,void 0),O(r,D,void 0),O(r,d,{}),O(r,V,void 0),O(r,C,void 0),O(r,A,void 0),x(r,"minLevel",void 0),x(r,"maxLevel",void 0),x(r,"thresholds",he(new Array(30)).map(function(y,f){return 8/Math.pow(2,f)})),x(r,"curvatureResolution",5),x(r,"tileMargin",0),x(r,"clearTiles",function(){Object.values(i(d,r)).forEach(function(y){y.forEach(function(f){f.obj&&(r.remove(f.obj),ne(f.obj),delete f.obj)})}),I(d,r,{})}),I(P,r,n),r.tileUrl=s,I(T,r,b),r.minLevel=u,r.maxLevel=m,r.level=0,r.add(I(A,r,new le(new ue(i(P,r)*.99,180,90),new je({color:0})))),i(A,r).visible=!1,i(A,r).material.polygonOffset=!0,i(A,r).material.polygonOffsetUnits=3,i(A,r).material.polygonOffsetFactor=1,r}return Ne(e,t),Ve(e,[{key:"tileUrl",get:function(){return i(X,this)},set:function(r){I(X,this,r),this.updatePov(i(C,this))}},{key:"level",get:function(){return i(D,this)},set:function(r){var l,s=this;i(d,this)[r]||W(G,this,nt).call(this,r);var o=i(D,this);if(I(D,this,r),!(r===o||o===void 0)){if(i(A,this).visible=r>0,i(d,this)[r].forEach(function(a){return a.obj&&(a.obj.material.depthWrite=!0)}),o<r&&((l=i(d,this)[o])===null||l===void 0||l.forEach(function(a){return a.obj&&(a.obj.material.depthWrite=!1)})),o>r)for(var u=r+1;u<=o;u++)i(d,this)[u]&&i(d,this)[u].forEach(function(a){a.obj&&(s.remove(a.obj),ne(a.obj),delete a.obj)});W(G,this,oe).call(this)}}},{key:"updatePov",value:function(r){var l=this;if(!(!r||!(r instanceof Ie))){I(C,this,r);var s;if(I(V,this,function(c){if(!c.hullPnts){var b=360/Math.pow(2,l.level),y=c.lng,f=c.lat,E=c.latLen,p=y-b/2,j=y+b/2,g=f-E/2,w=f+E/2;c.hullPnts=[[f,y],[g,p],[w,p],[g,j],[w,j]].map(function(v){var S=F(v,2),M=S[0],_=S[1];return ye(M,_,i(P,l))}).map(function(v){var S=v.x,M=v.y,_=v.z;return new te(S,M,_)})}return s||(s=new Le,r.updateMatrix(),r.updateMatrixWorld(),s.setFromProjectionMatrix(new Ae().multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse))),c.hullPnts.some(function(v){return s.containsPoint(v.clone().applyMatrix4(l.matrixWorld))})}),this.tileUrl){var o=r.position.clone(),u=o.distanceTo(this.getWorldPosition(new te)),a=(u-i(P,this))/i(P,this),m=this.thresholds.findIndex(function(c){return c&&c<=a});this.level=Math.min(this.maxLevel,Math.max(this.minLevel,m<0?this.thresholds.length:m)),W(G,this,oe).call(this)}}}}])})(Te);function nt(t){var e=this;if(t>et){i(d,this)[t]=[];return}var n=i(d,this)[t]=Z(t,i(T,this));n.forEach(function(r){return r.centroid=ye(r.lat,r.lng,i(P,e))}),n.octree=Re().x(function(r){return r.centroid.x}).y(function(r){return r.centroid.y}).z(function(r){return r.centroid.z}).addAll(n)}function oe(){var t=this;if(!(!this.tileUrl||this.level===void 0||!i(d,this).hasOwnProperty(this.level))&&!(!i(V,this)&&this.level>Ye)){var e=i(d,this)[this.level];if(i(C,this)){var n=this.worldToLocal(i(C,this).position.clone());if(e.octree){var r,l=this.worldToLocal(i(C,this).position.clone()),s=(l.length()-i(P,this))*tt;e=(r=e.octree).findAllWithinRadius.apply(r,he(l).concat([s]))}else{var o=Qe(n),u=(o.r/i(P,this)-1)*rt,a=u/Math.cos(L(o.lat)),m=[o.lng-a,o.lng+a],c=[o.lat+u,o.lat-u],b=ie(this.level,i(T,this),m[0],c[0]),y=F(b,2),f=y[0],E=y[1],p=ie(this.level,i(T,this),m[1],c[1]),j=F(p,2),g=j[0],w=j[1];!e.record&&(e.record={});var v=e.record;if(!v.hasOwnProperty("".concat(Math.round((f+g)/2),"_").concat(Math.round((E+w)/2))))e=Z(this.level,i(T,this),f,E,g,w).map(function(h){var U="".concat(h.x,"_").concat(h.y);return v.hasOwnProperty(U)?v[U]:(v[U]=h,e.push(h),h)});else{for(var S=[],M=f;M<=g;M++)for(var _=E;_<=w;_++){var k="".concat(M,"_").concat(_);v.hasOwnProperty(k)||(v[k]=Z(this.level,i(T,this),M,_,M,_)[0],e.push(v[k])),S.push(v[k])}e=S}}}e.filter(function(h){return!h.obj}).filter(i(V,this)||function(){return!0}).forEach(function(h){var U=h.x,_e=h.y,be=h.lng,N=h.lat,H=h.latLen,ge=360/Math.pow(2,t.level);if(!h.obj){var $=ge*(1-t.tileMargin),q=H*(1-t.tileMargin),we=L(be),Pe=L(-N),Y=new le(new ue(i(P,t),Math.ceil($/t.curvatureResolution),Math.ceil(q/t.curvatureResolution),L(90-$/2)+we,L($),L(90-q/2)+Pe,L(q)),new xe);if(i(T,t)){var Se=[N+H/2,N-H/2].map(function(z){return .5-z/180}),ee=F(Se,2),Ee=ee[0],Oe=ee[1];Ze(Y.geometry.attributes.uv,Ee,Oe)}h.obj=Y}h.loading||(h.loading=!0,new Ce().load(t.tileUrl(U,_e,t.level),function(z){var R=h.obj;R&&(z.colorSpace=Ue,R.material.map=z,R.material.color=null,R.material.needsUpdate=!0,t.add(R)),h.loading=!1}))})}}export{ut as T};
